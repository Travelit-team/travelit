<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <th:block th:replace="fragments/header :: head"></th:block>
    <th:block th:replace="fragments/footer :: head"></th:block>
    <link th:href="@{/css/product/productList.css}" rel="stylesheet">
    <link th:href="@{/css/product/paging.css}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.css">
    <script src="https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.min.js"></script>
</head>
<body>
    <!-- í—¤ë” -->
    <header th:replace="fragments/header :: header"></header>

    <button onclick="location.href='/product/productWrite'" class="product-write">ìƒí’ˆ ë“±ë¡</button>

    <!-- ê²€ìƒ‰ -->
    <!-- onsubmitì€ í¼ ì‹¤í–‰ ì‹œ ì‹¤í–‰í•  jsë¥¼ ì§€ì • , í•˜ì§€ë§Œ ì‹¤í–‰í•˜ì§€ ì•Šì„ ê²ƒì´ë¯€ë¡œ false -->
    <form id="searchForm" onsubmit="return false;" autocomplete="off">
        <div class="search-container">
            <div class="title">íœ´ê°€ëŠ” ë§Œë“œëŠ” ê²ƒì´ë‹¤!</div></br>
            <div class="subTitle">í‹°ì¼“, íˆ¬ì–´, ì•¡í‹°ë¹„í‹°, êµí†µ</div>
            <div class="search-area">
                <select id="searchType" name="searchType" title="ê²€ìƒ‰ ìœ í˜• ì„ íƒ" class="search-filter">
                    <option value="">ì „ì²´ ê²€ìƒ‰</option>
                    <option value="PRO_NAME">ì œëª©</option>
                    <option value="PRO_CONTENT">ë‚´ìš©</option>
                    <option value="PRO_LOCATION">ì§€ì—­</option>
                    <option value="PRO_CATEGORY_TOTAL">ì¹´í…Œê³ ë¦¬</option>
                </select>
                <input type="text" id="keyword" name="keyword" class="search-input" placeholder="ì˜¤ëŠ˜ì€ ì–´ë””ë¡œ ë– ë‚˜ë³¼ê¹Œìš”?" title="í‚¤ì›Œë“œ ì…ë ¥" onkeydown="searchOnEnter(event)"/>
                <!-- movePage()ëŠ” í˜ì´ì§€ ì´ë™ í´ë¦­ ì´ë²¤íŠ¸ í˜ì´ì§€ ë²ˆí˜¸ 1ë¡œ ì§€ì • -->
                <button type="button" onclick="movePage(1);" class="search-btn"><span>ê²€ìƒ‰</span></button>
            </div>
        </div>
    </form>

    <!--ì¹´í…Œê³ ë¦¬-->
    <div class="category-container">
        <select id="searchCategory" title="ê²€ìƒ‰ ìœ í˜• ì„ íƒ" class="search-filter-category">
            <option value="PRO_CATEGORY_TOTAL">ì¹´í…Œê³ ë¦¬</option>
            <option value="ì…ì¥ê¶Œ">ì…ì¥ê¶Œ</option>
            <option value="ì•¡í‹°ë¹„í‹°">ì•¡í‹°ë¹„í‹°</option>
            <option value="íˆ¬ì–´">íˆ¬ì–´</option>
            <option value="êµí†µ">êµí†µ</option>
        </select>
    </div>

    <!-- slider -->
    <div>
        <div class="slider">
            <div><img class="img_size" src="/images/product/slider/Seoul.jpeg" alt=""></div>
            <div><img class="img_size" src="/images/product/slider/Gyeonggi.jpeg" alt=""></div>
            <div><img class="img_size" src="/images/product/slider/Gangwon.jpeg" alt=""></div>
            <div><img class="img_size" src="/images/product/slider/Chungcheongnam-do.jpeg" alt=""></div>
            <div><img class="img_size" src="/images/product/slider/Daejeon.jpeg" alt=""></div>
            <div><img class="img_size" src="/images/product/slider/Gyeongsangbuk-do.jpeg" alt=""></div>
            <div><img class="img_size" src="/images/product/slider/Gyeongsangnam-do.jpeg" alt=""></div>
            <div><img class="img_size" src="/images/product/slider/Jeju.jpeg" alt=""></div>
        </div>
    </div>

    <!-- ìì—­ -->
    <div id="location-list-container">
        <div class="region-container">
            <div class="region" onclick="selectRegion('ì „êµ­')">
                <div class="circle" style="background-image: url('/images/product/localCategory/korea.png');"></div>
                <div class="label">ì „êµ­</div>
            </div>

            <div class="region" onclick="selectRegion('ì„œìš¸')">
                <div class="circle" style="background-image: url('/images/product/localCategory/seoul1.jpeg');"></div>
                <div class="label">ì„œìš¸</div>
            </div>
            <div class="region" onclick="selectRegion('ê²½ê¸°ë„')">
                <div class="circle" style="background-image: url('/images/product/localCategory/gyeong-gi-do1.jpeg');"></div>
                <div class="label">ê²½ê¸°ë„</div>
            </div>
            <div class="region" onclick="selectRegion('ì¸ì²œ')">
                <div class="circle" style="background-image: url('/images/product/localCategory/incheon1.jpeg');"></div>
                <div class="label">ì¸ì²œ</div>
            </div>
            <div class="region" onclick="selectRegion('ì¶©ì²­ë„')">
                <div class="circle" style="background-image: url('/images/product/localCategory/Chungcheong-do1.jpeg');"></div>
                <div class="label">ì¶©ì²­ë„</div>
            </div>
            <div class="region" onclick="selectRegion('ê°•ì›ë„')">
                <div class="circle" style="background-image: url('/images/product/localCategory/Gangwon-do1.jpeg');"></div>
                <div class="label">ê°•ì›ë„</div>
            </div>
            <div class="region" onclick="selectRegion('ì „ë¼ë„')">
                <div class="circle" style="background-image: url('/images/product/localCategory/Jeolla-do1.jpeg');"></div>
                <div class="label">ì „ë¼ë„</div>
            </div>
            <div class="region" onclick="selectRegion('ê²½ìƒë„')">
                <div class="circle" style="background-image: url('/images/product/localCategory/Gyeongsang-do1.jpeg');"></div>
                <div class="label">ê²½ìƒë„</div>
            </div>
            <div class="region" onclick="selectRegion('ì œì£¼ë„')">
                <div class="circle" style="background-image: url('/images/product/localCategory/Jeju-do1.jpeg');"></div>
                <div class="label">ì œì£¼ë„</div>
            </div>

        </div>
    </div>

    <!-- ì¡°íšŒìˆ˜ ìƒìœ„ 5ê°œ ìƒí’ˆ -->
    <div class="view-produrt-title">ğŸ¤© ì¸ê¸° TOP 4</div>
    <div class="product-container">
        <div th:each="product : ${fiveProduct}">
            <div class="card" th:onclick="'goViewPage(' + ${product.PRO_ID} + ')'">
                <img th:src="${product.PRO_IMG_NAME}" th:alt="${product.PRO_NAME}" class="card-img"/>
                <div class="card-content">
                    <div class="card-content-group01">
                        <div class="card-content-01">
                            íŒë§¤ê¸°ê°„ <span th:text="${#dates.format(product.TOUR_START, 'MM-dd')}"></span> ~ <span th:text="${#dates.format(product.TOUR_END, 'MM-dd')}"></span></span>
                        </div>
                        <div class="card-content-02">ì¡°íšŒ <span th:text="${product.PRO_VIEW}"></span></div>
                    </div>
                    <div class="card-content-03" th:text="${product.PRO_NAME}"></div>
                    <div class="card-content-04">â‚© <span th:text="${#numbers.formatDecimal(product.PRO_PRICE, 0, 'COMMA', 0, 'POINT')}"></span></div>
                </div>
            </div>
        </div>
    </div>


    <!-- ëª©ë¡ ì˜ì—­ -->
    <div class="produrt-title">ìƒí’ˆëª©ë¡</div>
    <div id="list" class="product-container"></div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="paging"></div>

    <!-- footer -->
    <footer th:replace="fragments/footer :: footer"></footer>
</body>

<script th:inline="javascript">
    /*<![CDATA[*/

    window.onload = () => {
        findAllProduct();
        setQueryStringParams();
    }

    //ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
    function findAllProduct() {
        //ProductPagingResponseì˜ list
        const list = [[${response.list}]];
        //ê°’ ì—†ìœ¼ë©´ ë©”ì‹œì§€
        if (!list.length) {
            document.getElementById('list').innerHTML = '<div>ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            drawPage();
        }
        //ProductPagingResponseì˜ productPagination(responseëŠ” ì»¨íŠ¸ë¡¤ëŸ¬)
        const pagination = [[${response.productPagination}]];
        //@ModelAttribute ProductSearchì˜ params
        const params = [[${params}]];
        //ê²Œì‹œê¸€ ë²ˆí˜¸ ì²˜ë¦¬
        let num = pagination.totalRecordCount - ((params.page - 1) * params.recordSize);
        //ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        drawList(list, num);
        //í˜ì´ì§€ ë²ˆí˜¸ ë Œë”ë§
        drawPage(pagination, params);
    }

    //ë¦¬ìŠ¤íŠ¸ HTML
    function drawList(list, num) {
        //HTML ì €ì¥ ë³€ìˆ˜
        let html = '';
        //(ì „ì²´ ë°ì´í„° ìˆ˜ - ((í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸ - 1) * í˜ì´ì§€ë‹¹ ì¶œë ¥í•  ë°ì´í„° ê°œìˆ˜))
        list.forEach(row => {
            const startDate = new Date(row.tour_START);
            const endDate = new Date(row.tour_END);

            //ë‚ ì§œ í¬ë§·
            const formattedStartDate = `${(startDate.getMonth() + 1).toString().padStart(2, '0')}-${startDate.getDate().toString().padStart(2, '0')}`;
            const formattedEndDate = `${(endDate.getMonth() + 1).toString().padStart(2, '0')}-${endDate.getDate().toString().padStart(2, '0')}`;
            const formattedPrice = formatPrice(row.pro_PRICE);


            html += `
                        <div class="card" onclick="goViewPage(${row.pro_ID});">
                            <img src="${row.pro_IMG_NAME}" alt="${row.pro_Name}" th:alt="${row.pro_Name}" class="card-img"/>
                            <div class="card-content">
                            <div class="card-content-group01">
                                <div class="card-content-01">íŒë§¤ê¸°ê°„ ${formattedStartDate} ~ ${formattedEndDate}</div>
                                <div class="card-content-02">ì¡°íšŒ ${row.pro_VIEW}</div>
                            </div>
                            <div class="card-content-03">${row.pro_NAME}</div>
                            <div class="card-content-04">â‚© <span id="formattedPrice_${row.pro_ID}">${formattedPrice}</span></div>
                        </div>
                            </div>
                        </div>
                `;
        })
        //list ìš”ì†Œ HTML ë°°ì¹˜
        document.getElementById('list').innerHTML = html;
    }

    //ê°€ê²© í¬ë§·íŒ… í•¨ìˆ˜
    function formatPrice(price) {
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // í˜ì´ì§€ HTML
    function drawPage(pagination, params) {
        //íŒŒë¼ë¯¸í„°ê°€ ì—†ëŠ” ê²½ìš°, í˜ì´ì§€ ë²ˆí˜¸ ì œê±°
        if (!pagination || !params) {
            document.querySelector('.paging').innerHTML = '';
            throw new Error('ì—†ìŠˆ');
        }
        //HTML ì €ì¥
        let html = '';
        // ì‹œì‘ í˜ì´ì§€(startPage)ê°€ 1ì´ ì•„ë‹Œ ê²½ìš° ì‹œì‘ í˜ì´ì§€ ë²„íŠ¼, ì´ì „ í˜ì´ì§€ ë²„íŠ¼ ì¶”ê°€
        if (pagination.existPrevPage) {
            html += `
                    <a href="javascript:void(0);" onclick="movePage(1)" class="page_bt first">ì‹œì‘ í˜ì´ì§€</a>
                    <a href="javascript:void(0);" onclick="movePage(${pagination.startPage - 1})" class="page_bt prev">ì´ì „ í˜ì´ì§€</a>
                `;
        }
        //ì‹œì‘ í˜ì´ì§€ ë§ˆì§€ë§‰ í˜ì´ì§€ ì‚¬ì´ í˜ì´ì§€ ë²ˆí˜¸ ë„˜ë²„ë§
        html += '<p>';
        for (let i = pagination.startPage; i <= pagination.endPage; i++) {
            html += (i !== params.page)
                ? `<a href="javascript:void(0);" onclick="movePage(${i});">${i}</a>`
                : `<span class="on">${i}</span>`
        }
        html += '</p>';
        //ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ê³¼ ë í˜ì´ì§€ ë²„íŠ¼ ì¶”ê°€
        if (pagination.existNextPage) {
            html += `
                    <a href="javascript:void(0);" onclick="movePage(${pagination.endPage + 1});" class="page_bt next">ë‹¤ìŒ í˜ì´ì§€</a>
                    <a href="javascript:void(0);" onclick="movePage(${pagination.totalPageCount});" class="page_bt last">ë§ˆì§€ë§‰ í˜ì´ì§€</a>
                `;
        }
        //class "paging"ì¸ ìš”ì†Œ ë Œë”ë§
        document.querySelector('.paging').innerHTML = html;
    }

    //í˜ì´ì§€ ì´ë™
    function movePage(page) {
        //ê²€ìƒ‰í¼
        const form = document.getElementById('searchForm');
        //drawPage( ) onclick ì´ë²¤íŠ¸ë¥¼ í†µí•´ ì „ë‹¬ë°›ì€ í˜ì´ì§€ ë²ˆí˜¸ë¡œ ê°ì²´ ìƒì„±
        const queryParams = {
            page: (page) ? page : 1,
            recordSize: 20,
            pageSize: 5,
            searchType: form.searchType.value,
            keyword: form.keyword.value
        }
        //location.pathname: product/list
        //new URLSearchParams(queryParams).toString() : queryParamsì˜ ëª¨ë“  í”„ë¡œí¼í‹°(key-value) ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ìœ¼ë¡œ ë³€í™˜
        location.href = location.pathname + '?' + new URLSearchParams(queryParams).toString();
    }

    //ê²€ìƒ‰ íŒŒë¼ë¯¸í„° ìœ ì§€: íŒŒë¼ë¯¸í„° ê°ì²´í™” í›„ searchFormì— ì„¸íŒ…
    function setQueryStringParams() {
        if (!location.search) {
            return false;
        }
        const form = document.getElementById('searchForm');
        new URLSearchParams(location.search).forEach((value, key) => {
            if (form[key]) {
                form[key].value = value;
            }
        })
    }

    // ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€
    function goViewPage(pro_ID) {
        const queryString = (location.search) ? location.search + `&PRO_ID=${pro_ID}` : `?PRO_ID=${pro_ID}`;
        location.href = '/product/productView' + queryString;
    }


    //ìŠ¬ë¼ì´ë”
    $(document).ready(function () {
        $('.slider').bxSlider({
            auto: true,
            speed: 500,
            pause: 5000,
            mode: 'fade',
            pager: false,
            adaptiveHeight: true
        });

        function showControls() {
            $('.bx-prev, .bx-next').css('display', 'inline-block');
        }

        function hideControls() {
            $('.bx-prev, .bx-next').css('display', 'none');
        }

        $('.bx-viewport').hover(showControls, hideControls);
        $('.bx-prev, .bx-next').hover(showControls, showControls);
    });


</script>

<script th:inline="javascript">
    //ì§€ì—­ ì„ íƒ
    function selectRegion(regionName) {
        // ì „êµ­"ì„ ì„ íƒ, ê²€ìƒ‰ì–´ëŠ” ìœ ì§€, ì§€ì—­ ì´ˆê¸°í™”
        if (regionName === "ì „êµ­") {
            findAllProduct(); //ëª¨ë“  ê²°ê³¼ í˜¸ì¶œ
            return; //
        }

        //í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§
        const filteredList = filterByRegion(regionName);

        //í•„í„°ë§ëœ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        drawList(filteredList);
    }

    //í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì§€ì—­ í•„í„°ë§
    function filterByRegion(regionName) {
        const currentList = [[${response.list}]]; // í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼

        //í•„í„°ë§ëœ ê²°ê³¼ ì €ì¥
        let filteredList = [];

        //í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ ì§€ì—­ ì¼ì¹˜
        currentList.forEach(item => {
            if (item.pro_LOCATION === regionName) {
                filteredList.push(item);
            }
        });

        return filteredList;
    }

    //ê²€ìƒ‰ ì—”í„°
    function searchOnEnter(event) {
        if (event.key === "Enter") {
            movePage(1);
        }
    }

    //ì¹´í…Œê³ ë¦¬ ì„ íƒ í•„í„°ë§
    document.getElementById('searchCategory').addEventListener('change', function () {
        const selectedCategory = this.value; // ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ ê°’ ê°€ì ¸ì˜¤ê¸°
        const currentList = [[${response.list}]]; // í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼

        //ì¹´í…Œê³ ë¦¬ ì„ íƒ ëª¨ë“  ìƒí’ˆ
        if (selectedCategory === "PRO_CATEGORY_TOTAL") {
            drawList(currentList); // í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê·¸ëŒ€ë¡œ ë³´ì—¬ì¤Œ
            return; // í•¨ìˆ˜ ì¢…ë£Œ
        }

        //í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ì¹´í…Œê³ ë¦¬ì— í•„í„°ë§
        const filteredList = filterByCategory(currentList, selectedCategory);

        //ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        drawList(filteredList);
    });

    //í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ ì¹´í…Œê³ ë¦¬ í•„í„°ë§
    function filterByCategory(currentList, selectedCategory) {
        //í•„í„°ë§ëœ ê²°ê³¼ ì €ì¥
        let filteredList = [];

        //í˜„ì¬ ê²€ìƒ‰ ê²°ê³¼ì—ì„œì¹´í…Œê³ ë¦¬í•„í„°ë§
        currentList.forEach(item => {
            if (item.pro_CATEGORY_TOTAL === selectedCategory) {
                filteredList.push(item);
            }
        });

        return filteredList;
    }

</script>

</html>